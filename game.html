<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة كلمات متقاطعة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a5298);
            min-height: 100vh;
            padding: 10px;
            color: white;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .top-bar {
            background: linear-gradient(135deg, #8B4513, #D4AC0D);
            border: 2px solid #F7DC6F;
            border-radius: 10px;
            padding: 8px;
            color: white;
            display: flex;
            align-items: center;
            min-height: 10px;
            justify-content: space-between;
            margin-bottom: 15px;
            box-shadow: 0 4px 4px rgba(0,0,0,0.2);
        }
        
        .back-button {
            background: #D4AC0D;
            border: none;
            border-radius: 5px;
            padding: 5px 5px;
            color: white;
            font-size: 10px;
            min-height: 15px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .score {
            font-size: 14px;
            font-weight: bold;
        }
        
        .level {
            font-size: 14px;
            font-weight: bold;
        }
        
        .progress-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #D4AC0D;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .progress-text {
            font-size: 12px;
            margin-bottom: 7px;
            color: #F7DC6F;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            height: 10px;
            overflow: hidden;
        }
        
        .progress {
            background: linear-gradient(135deg, #D4AC0D, #8B4513);
            height: 50%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .question-box {
            background: linear-gradient(135deg, #8B4513, #D4AC0D);
            border: 2px solid #F7DC6F;
            border-radius: 15px;
            padding: 10px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            line-height: 1.5;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* منطقة المربعات للإجابة */
        .answer-slots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 15px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #D4AC0D;
            border-radius: 15px;
            min-height: 80px;
        }
        
        .answer-slot {
            width: 45px;
            height: 45px;
            background: white;
            border: 2px solid #D4AC0D;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            color: #1a2a6c;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .answer-slot.filled {
            background: linear-gradient(135deg, #F7DC6F, #D4AC0D);
            color: #1A5276;
            transform: scale(1.05);
        }
        
        .answer-slot.empty {
            background: white;
            border: 2px dashed #D4AC0D;
        }
        
        .letters-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .letter-button {
            background: linear-gradient(135deg, #1a2a6c, #2a5298);
            border: 2px solid #D4AC0D;
            border-radius: 10px;
            padding: 15px 5px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .letter-button:active {
            transform: scale(0.95);
        }
        
        .letter-button.used {
            background: #7F8C8D;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .letter-button.hidden {
            display: none;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .control-button {
            background: linear-gradient(135deg, #D4AC0D, #F7DC6F);
            border: 2px solid #1A5276;
            border-radius: 15px;
            padding: 15px 10px;
            color: #1A5276;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .control-button:active {
            transform: scale(0.98);
        }
        
        .control-button.disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* منطقة رسائل التصحيح - مخفية بشكل افتراضي */
        .message-area {
            min-height: 40px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .correct-message {
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #27ae60;
            border-radius: 15px;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #2ecc71;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: fadeInOut 3s ease-in-out;
        }
        
        .wrong-message {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #c0392b;
            border-radius: 15px;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        .results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .results-box {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border: 3px solid #D4AC0D;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .results-title {
            font-size: 24px;
            color: #F7DC6F;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .results-stats {
            font-size: 18px;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .results-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .result-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .next-level-btn {
            background: linear-gradient(135deg, #D4AC0D, #F7DC6F);
            color: #1e3c72;
        }
        
        .levels-btn {
            background: linear-gradient(135deg, #3498DB, #2980b9);
            color: white;
        }

        /* إخفاء معلومات التصحيح من الواجهة */
        .debug-info {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <button class="back-button" onclick="goBack()">  ↩️ رجوع</button>
            <div class="score" id="score">النقاط: 0</div>
            <div class="level" id="level">المستوى 1</div>
        </div>
        
        <div class="progress-section">
            <div class="progress-text" id="progressText">الإجابات الصحيحة: 0/10</div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>

        <!-- منطقة رسائل التصحيح -->
        <div class="message-area" id="messageArea">
            <!-- الرسائل ستظهر هنا عند التصحيح -->
        </div>
        
        <div class="question-box" id="question">
            جاري تحميل السؤال...
        </div>
        
        <!-- منطقة المربعات للإجابة -->
        <div class="answer-slots" id="answerSlots">
            <!-- المربعات سيتم إنشاؤها بالجافاسكربت -->
        </div>
        
        <div class="letters-grid" id="lettersGrid">
        </div>
        
        <div class="controls">
            <div class="control-button" id="removeLettersBtn" onclick="removeRandomLetters()">
                🗑️ حذف 4 أحرف
            </div>
            <div class="control-button" id="helpBtn" onclick="giveHelp()">
                🔤 حرفين
            </div>
        </div>
    </div>

    <div class="results-overlay" id="resultsOverlay">
        <div class="results-box">
            <div class="results-title">🎊 مبروك! أكملت المستوى</div>
            <div class="results-stats" id="resultsStats"></div>
            <div class="results-buttons">
                <button class="result-btn next-level-btn" onclick="goToNextLevel()">المستوى التالي ➡️</button>
                <button class="result-btn levels-btn" onclick="goToLevels()">📋 قائمة المستويات</button>
            </div>
        </div>
    </div>

    <!-- إخفاء معلومات التصحيح ولكن تبقى في الكود للاستخدام الداخلي -->
    <div class="debug-info" id="debugInfo"></div>

    <script>
        let currentAnswer = "";
        let userAnswer = "";
        let currentScore = 100;
        let currentLevel = 1;
        let questions = [];
        let answers = [];
        let usedQuestions = [];
        let correctAnswers = 0;
        const QUESTIONS_NEEDED = 10;
        let usedLetters = [];
        let availableLetters = [];

        function loadGame() {
            currentLevel = getUrlParameter('level') || 1;
            
            if (window.Android) {
                currentScore = Android.getCurrentScore();
                // استعادة التقدم المحفوظ
                correctAnswers = Android.getCorrectAnswers() || 0;
                const savedUsedQuestions = Android.getUsedQuestions();
                if (savedUsedQuestions) {
                    usedQuestions = savedUsedQuestions.split(',').map(Number).filter(n => !isNaN(n));
                }
                
                console.log("📊 تم استعادة التقدم - المستوى: " + currentLevel + 
                           "، الإجابات الصحيحة: " + correctAnswers + 
                           "، الأسئلة المستخدمة: " + usedQuestions.length);
            }
            
            document.getElementById('level').textContent = `المستوى ${currentLevel}`;
            updateScore();
            updateProgress();
            loadQuestion();
            updateButtonStates();
        }

        function loadQuestion() {
            console.log("🔍 تحميل سؤال جديد - المستوى: " + currentLevel + 
                       "، الإجابات الصحيحة: " + correctAnswers + 
                       "، الأسئلة المستخدمة: " + usedQuestions.length);
            
            if (window.Android && Android.getQuestions) {
                try {
                    questions = Android.getQuestions();
                    answers = Android.getAnswers();
                    
                    if (!questions || questions.length === 0) {
                        useDefaultQuestions();
                    }
                    
                } catch (error) {
                    console.error("خطأ في جلب الأسئلة:", error);
                    useDefaultQuestions();
                    return;
                }
            } else {
                useDefaultQuestions();
                return;
            }

            if (questions.length === 0) {
                document.getElementById('question').textContent = "لا توجد أسئلة لهذا المستوى";
                return;
            }

            let availableQuestions = [];
            for (let i = 0; i < questions.length; i++) {
                if (!usedQuestions.includes(i)) {
                    availableQuestions.push(i);
                }
            }

            if (availableQuestions.length === 0) {
                usedQuestions = [];
                availableQuestions = [...Array(questions.length).keys()];
            }

            const randomIndex = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            usedQuestions.push(randomIndex);

            document.getElementById('question').textContent = questions[randomIndex];
            currentAnswer = answers[randomIndex];
            userAnswer = "";
            usedLetters = [];
            
            // مسح أي رسائل سابقة
            clearMessage();
            
            // حفظ التقدم بعد كل سؤال
            saveProgress();
            
            updateAnswerDisplay();
            setupLettersGrid();
            updateButtonStates();
        }

        function useDefaultQuestions() {
            const allQuestions = {
                1: {
                    questions: [
                        "من هو أول نبي في الإسلام؟",
                        "من هوى النبي الذي كان والده نبي وجده نبي وابنه نبي ؟",
                        "من هو النبي الذي بنى السفينة؟",
                        "من هو النبي الذي لقب بكليم الله؟",
                        "من هو النبي الذي ألقى في النار فجعلها الله برداً وسلاماً؟",
                        "من هو النبي الذي اعطاه الله صوتا جملا فكان يرتل الزبور فمن هوى",
                        "من هو النبي الذي فلق البحر؟",
                        "من هو النبي الذي عاش في بطن الحوت؟",
                        "من هو النبي الذي كان يصنع من الطين طيراً؟",
                        "من هو خاتم الأنبياء والمرسلين؟"
                    ],
                    answers: ["آدم", "يعقوب", "نوح", "موسى", "إبراهيم", "داوود", "موسى", "يونس", "عيسى", "محمد"]
                },
                2: {
                    questions: [
                        "ما هي أول سورة في القرآن؟",
                        "ما هي أطول سورة في القرآن؟",
                        "ما هي أقصر سورة في القرآن؟",
                        "ما هي السورة التي تسمى قلب القرآن؟",
                        "ما هي السورة التي تسمى عروس القرآن؟",
                        "ما هي السورة التي تبدأ بالحمد لله؟",
                        "ما هي السورة التي لم تبدأ بالبسملة؟",
                        "ما هي السورة التي ذكرت فيها البسملة مرتين؟",
                        "ما هي السورة التي تسمى سورة النبي؟",
                        "ما هي السورة التي تسمى المنجية؟"
                    ],
                    answers: ["الفاتحة", "البقرة", "الكوثر", "يس", "الرحمن", "الفاتحة", "التوبة", "النمل", "التحريم", "الملك"]
                },
                3: {
                    questions: [
                        "كم عدد أركان الإسلام؟",
                        "كم عدد أركان الإيمان؟",
                        "ما هو أول ركن من أركان الإسلام؟",
                        "ما هو ثاني ركن من أركان الإسلام؟",
                        "كم عدد الركعات في صلاة الظهر؟",
                        "كم عدد الركعات في صلاة المغرب؟",
                        "ما هي شروط الصلاة؟",
                        "ما هي مبطلات الصلاة؟",
                        "ما هو حكم الصلاة؟",
                        "ما هو وقت صلاة الفجر؟"
                    ],
                    answers: ["خمسة", "ستة", "الشهادتان", "الصلاة", "أربع", "ثلاث", "الطهارة", "الكلام", "الفرض", "الصبح"]
                },
                4: {
                    questions: [
                        "في أي عام ولد النبي محمد؟",
                        "ما هي معجزة النبي محمد الخالدة؟",
                        "من هي أول زوجة للنبي محمد؟",
                        "من هو أول من آمن بالنبي من الصبيان؟",
                        "ما اسم الغار الذي كان يتعبد فيه النبي؟",
                        "كم كان عمر النبي عندما بُعث؟",
                        "ما هي الهجرة؟",
                        "إلى أي مدينة هاجر النبي؟",
                        "ما هي غزوة بدر؟",
                        "كم استمرت دعوة النبي في مكة؟"
                    ],
                    answers: ["عامالفيل", "القرآن", "خديجة", "علي", "حراء", "أربعون", "الانتقال", "المدينة", "معركة", "ثلاثة عشر"]
                },
                5: {
                    questions: [
                        "ما هو خلق الإسلام؟",
                        "ما هو أفضل الأخلاق؟",
                        "ماذا يعني الصدق؟",
                        "ما ضد الصدق؟",
                        "ما هو خلق الكرم؟",
                        "ما هو خلق التواضع؟",
                        "ما هو خلق الصبر؟",
                        "ما هو خلق الأمانة؟",
                        "ما هو خلق الحياء؟",
                        "ما هو خلق الوفاء؟"
                    ],
                    answers: ["الأخلاق", "الصدق", "الصدق", "الكذب", "العطاء", "التواضع", "الصبر", "الأمانة", "الحياء", "الوفاء"]
                },
                6: {
                    questions: [
                        "من هو أول خليفة للمسلمين؟",
                        "من هو ثاني الخلفاء الراشدين؟",
                        "من هو الخليفة الذي أسس الدواوين؟",
                        "من هو قائد معركة اليرموك؟",
                        "متى كانت غزوة الأحزاب؟",
                        "من هو باني المسجد الأقصى؟",
                        "من هو فاتح الأندلس؟",
                        "من هو قائد معركة نهاوند؟",
                        "من هو مؤسس الدولة الأموية؟",
                        "من هو قائد معركة القادسية؟"
                    ],
                    answers: ["أبوبكر", "عمر", "عمر", "خالد", "خمسة", "سليمان", "طارق", "النعمان", "معاوية", "سعد"]
                },
                7: {
                    questions: [
                        "ما هو أول واجب على المكلف؟",
                        "كم عدد أركان الإيمان؟",
                        "ما هو الركن الأول من أركان الإيمان؟",
                        "ما هو الركن الثاني من أركان الإيمان؟",
                        "ما هو الركن الثالث من أركان الإيمان؟",
                        "ما هو الركن الرابع من أركان الإيمان؟",
                        "ما هو الركن الخامس من أركان الإيمان؟",
                        "ما هو الركن السادس من أركان الإيمان؟",
                        "ما معنى التوحيد؟",
                        "ما هي أنواع التوحيد؟"
                    ],
                    answers: ["التوحيد", "ستة", "الإيمان", "الملائكة", "الكتب", "الرسل", "اليوم", "القدر", "التوحيد", "ثلاثة"]
                },
                8: {
                    questions: [
                        "كم عدد الصلوات المفروضة؟",
                        "ما هي أول صلاة فرضت؟",
                        "كم عدد ركعات صلاة الفجر؟",
                        "كم عدد ركعات صلاة الظهر؟",
                        "كم عدد ركعات صلاة العصر؟",
                        "كم عدد ركعات صلاة المغرب؟",
                        "كم عدد ركعات صلاة العشاء؟",
                        "ما هي شروط الصيام؟",
                        "كم عدد أركان الحج؟",
                        "ما هو الركن الأول من أركان الحج؟"
                    ],
                    answers: ["خمس", "الظهر", "ركعتان", "أربع", "أربع", "ثلاث", "أربع", "الإسلام", "أربعة", "الإحرام"]
                },
                9: {
                    questions: [
                        "ما هي معجزة النبي موسى؟",
                        "ما هي معجزة النبي عيسى؟",
                        "ما هي معجزة النبي صالح؟",
                        "ما هي معجزة النبي إبراهيم؟",
                        "ما هي معجزة النبي سليمان؟",
                        "ما هي معجزة النبي يونس؟",
                        "ما هي معجزة النبي أيوب؟",
                        "ما هي معجزة النبي داود؟",
                        "ما هي معجزة النبي يوسف؟",
                        "ما هي معجزة النبي محمد؟"
                    ],
                    answers: ["العصا", "إحياء", "الناقة", "النار", "الجن", "الحوت", "الصبر", "الحديد", "التأويل", "القرآن"]
                },
                10: {
                    questions: [
                        "من هو أول من أسلم من الرجال؟",
                        "من هو أول من أسلم من النساء؟",
                        "من هو أول من أسلم من الصبيان؟",
                        "من هو الصديق؟",
                        "من هو الفاروق؟",
                        "من هو ذو النورين؟",
                        "من هو سيف الله المسلول؟",
                        "من هو حبر الأمة؟",
                        "من هو ترجمان القرآن؟",
                        "من هو أسد الله؟"
                    ],
                    answers: ["أبوبكر", "خديجة", "علي", "أبوبكر", "عمر", "عثمان", "خالد", "عبدالله", "ابنعباس", "حمزة"]
                },
                11: {
                    questions: [
                        "متى كانت غزوة بدر؟",
                        "متى كانت غزوة أحد؟",
                        "متى كانت غزوة الخندق؟",
                        "متى كانت صلح الحديبية؟",
                        "متى كانت فتح مكة؟",
                        "متى كانت حجة الوداع؟",
                        "متى كانت معركة اليرموك؟",
                        "متى كانت معركة القادسية؟",
                        "متى كانت معركة نهاوند؟",
                        "متى كانت معركة بلاط الشهداء؟"
                    ],
                    answers: ["الثانية", "الثالثة", "الخامسة", "السادسة", "الثامنة", "العاشرة", "الخامسة", "الرابعة", "الخامسة", "السادسة"]
                },
                12: {
                    questions: [
                        "ما هو آخر كتاب أنزله الله؟",
                        "من هو آخر نبي؟",
                        "ما هي آخر سورة نزلت؟",
                        "ما هي آخر آية نزلت؟",
                        "من هو آخر من مات من الصحابة؟",
                        "ما هي آخر غزوة للرسول؟",
                        "من هو آخر الخلفاء الراشدين؟",
                        "ما هو آخر أركان الإسلام؟",
                        "ما هو آخر أركان الإيمان؟",
                        "ما هو آخر دعاء النبي؟"
                    ],
                    answers: ["القرآن", "محمد", "النصر", "الربا", "أنس", "تبوك", "علي", "الحج", "القدر", "الصلاة"]
                }
            };

            const levelData = allQuestions[currentLevel] || allQuestions[1];
            questions = levelData.questions;
            answers = levelData.answers;
        }

        function setupLettersGrid() {
            const lettersGrid = document.getElementById('lettersGrid');
            lettersGrid.innerHTML = '';
            
            const letters = shuffleLetters(currentAnswer + generateExtraLetters());
            availableLetters = letters.split('');
            
            availableLetters.forEach(letter => {
                const letterButton = document.createElement('div');
                letterButton.className = 'letter-button';
                letterButton.textContent = letter;
                letterButton.onclick = () => selectLetter(letter, letterButton);
                lettersGrid.appendChild(letterButton);
            });
        }

        function selectLetter(letter, button) {
            if (userAnswer.length < currentAnswer.length) {
                userAnswer += letter;
                usedLetters.push({letter: letter, button: button});
                button.classList.add('used');
                button.onclick = null;
                updateAnswerDisplay();
                
                // التحقق التلقائي عند اكتمال الإجابة
                if (userAnswer.length === currentAnswer.length) {
                    setTimeout(autoCheckAnswer, 500);
                }
            }
        }

        function updateAnswerDisplay() {
            const answerSlots = document.getElementById('answerSlots');
            answerSlots.innerHTML = '';
            
            // إنشاء مربعات فارغة لكل حرف في الإجابة
            for (let i = 0; i < currentAnswer.length; i++) {
                const slot = document.createElement('div');
                slot.className = `answer-slot ${i < userAnswer.length ? 'filled' : 'empty'}`;
                slot.textContent = i < userAnswer.length ? userAnswer[i] : '';
                
                // إضافة إمكانية المسح بالضغط على المربع
                if (i < userAnswer.length) {
                    slot.onclick = () => removeLetterFromSlot(i);
                }
                
                answerSlots.appendChild(slot);
            }
        }

        function removeLetterFromSlot(slotIndex) {
            if (slotIndex < userAnswer.length) {
                // إعادة الحرف إلى الشبكة
                const removedLetter = userAnswer[slotIndex];
                
                // إيجاد الزر المستخدم وإعادته
                const usedLetterIndex = usedLetters.findIndex(item => {
                    return item.letter === removedLetter && 
                           userAnswer.indexOf(removedLetter) === slotIndex;
                });
                
                if (usedLetterIndex !== -1) {
                    const usedLetter = usedLetters[usedLetterIndex];
                    usedLetter.button.classList.remove('used');
                    usedLetter.button.onclick = () => selectLetter(usedLetter.letter, usedLetter.button);
                    usedLetters.splice(usedLetterIndex, 1);
                }
                
                // إزالة الحرف من الإجابة
                userAnswer = userAnswer.slice(0, slotIndex) + userAnswer.slice(slotIndex + 1);
                updateAnswerDisplay();
            }
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
            
            const messageElement = document.createElement('div');
            messageElement.className = type === 'correct' ? 'correct-message' : 'wrong-message';
            messageElement.textContent = message;
            
            messageArea.appendChild(messageElement);
            
            // إزالة الرسالة تلقائياً بعد 3 ثواني
            setTimeout(() => {
                if (messageArea.contains(messageElement)) {
                    messageArea.removeChild(messageElement);
                }
            }, 3000);
        }

        function clearMessage() {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
        }

        function autoCheckAnswer() {
            if (userAnswer === currentAnswer) {
                currentScore += 10;
                correctAnswers++;
                
                if (window.Android) {
                    Android.updateScore(currentScore);
                }
                
                updateScore();
                updateProgress();
                updateButtonStates();
                
                // عرض رسالة التصحيح في المنطقة المخصصة
                showMessage('🎉 إجابة صحيحة! +10 نقاط', 'correct');
                
                // حفظ التقدم بعد الإجابة الصحيحة
                saveProgress();
                
                if (correctAnswers >= QUESTIONS_NEEDED) {
                    setTimeout(completeLevel, 1500);
                } else {
                    setTimeout(() => {
                        loadQuestion();
                    }, 1500);
                }
                
            } else {
                currentScore = Math.max(0, currentScore - 5);
                
                if (window.Android) {
                    Android.updateScore(currentScore);
                }
                
                updateScore();
                updateButtonStates();
                
                // عرض رسالة الخطأ في المنطقة المخصصة
                showMessage('❌ إجابة خاطئة! -5 نقاط', 'wrong');
                
                // حفظ التقدم بعد الإجابة الخاطئة
                saveProgress();
            }
        }

        function removeRandomLetters() {
            if (currentScore >= 3) {
                currentScore -= 3;
                
                const unusedLetterButtons = Array.from(document.querySelectorAll('.letter-button:not(.used)'));
                const lettersToRemove = Math.min(4, unusedLetterButtons.length);
                
                for (let i = 0; i < lettersToRemove; i++) {
                    if (unusedLetterButtons.length > 0) {
                        const randomIndex = Math.floor(Math.random() * unusedLetterButtons.length);
                        const letterButton = unusedLetterButtons[randomIndex];
                        letterButton.classList.add('hidden');
                        unusedLetterButtons.splice(randomIndex, 1);
                    }
                }
                
                updateScore();
                updateButtonStates();
                
                if (window.Android) {
                    Android.updateScore(currentScore);
                }
                
                showMessage(`🗑️ تم حذف ${lettersToRemove} أحرف عشوائية`, 'correct');
            } else {
                showMessage('نقاط غير كافية لحذف الأحرف!', 'wrong');
            }
        }

        function giveHelp() {
            if (currentScore >= 5) {
                currentScore -= 5;
                
                if (userAnswer.length < currentAnswer.length) {
                    const needed = currentAnswer.length - userAnswer.length;
                    const helpCount = Math.min(2, needed);
                    
                    for (let i = 0; i < helpCount; i++) {
                        userAnswer += currentAnswer[userAnswer.length];
                    }
                    
                    updateAnswerDisplay();
                    setupLettersGrid();
                    
                    // التحقق التلقائي إذا اكتملت الإجابة
                    if (userAnswer.length === currentAnswer.length) {
                        setTimeout(autoCheckAnswer, 500);
                    }
                }
                
                updateScore();
                updateButtonStates();
                
                if (window.Android) {
                    Android.updateScore(currentScore);
                }
                
                showMessage('🔤 تمت المساعدة في الإجابة', 'correct');
            } else {
                showMessage('نقاط غير كافية للمساعدة!', 'wrong');
            }
        }

        function saveProgress() {
            if (window.Android && Android.saveProgress) {
                Android.saveProgress(correctAnswers, usedQuestions.join(','));
                console.log("💾 تم حفظ التقدم - الإجابات: " + correctAnswers + "، الأسئلة: " + usedQuestions.length);
            }
        }

        function updateScore() {
            document.getElementById('score').textContent = `النقاط: ${currentScore}`;
        }

        function updateProgress() {
            const progress = (correctAnswers / QUESTIONS_NEEDED) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `الإجابات الصحيحة: ${correctAnswers}/${QUESTIONS_NEEDED}`;
        }

        function updateButtonStates() {
            document.getElementById('removeLettersBtn').className = 
                `control-button ${currentScore < 3 ? 'disabled' : ''}`;
            document.getElementById('helpBtn').className = 
                `control-button ${currentScore < 5 ? 'disabled' : ''}`;
        }

        function completeLevel() {
            console.log("🎊 إكمال المستوى: " + currentLevel + " - الإجابات الصحيحة: " + correctAnswers);
            
            if (window.Android) {
                Android.completeLevel();
            }
            
            showResults();
        }

        function showResults() {
            const resultsStats = document.getElementById('resultsStats');
            const nextLevel = parseInt(currentLevel) + 1;
            
            resultsStats.innerHTML = `
                <div>المستوى: ${currentLevel}</div>
                <div>الإجابات الصحيحة: ${correctAnswers}/${QUESTIONS_NEEDED}</div>
                <div>النقاط المكتسبة: ${correctAnswers * 10}</div>
                <div>النقاط الإجمالية: ${currentScore}</div>
                <div style="color: #F7DC6F; margin-top: 10px; font-weight: bold;">
                    🎉 ${nextLevel <= 12 ? 'تم فتح المستوى ' + nextLevel + '!' : 'أكملت جميع المستويات!'}
                </div>
            `;
            
            document.getElementById('resultsOverlay').style.display = 'flex';
        }

        function goToNextLevel() {
            const nextLevel = parseInt(currentLevel) + 1;
            console.log("➡️ الذهاب للمستوى التالي: " + nextLevel);
            
            if (nextLevel <= 12) {
                if (window.Android && Android.startLevel) {
                    Android.startLevel(nextLevel);
                } else {
                    window.location.href = `game.html?level=${nextLevel}`;
                }
            } else {
                goToLevels();
            }
        }

        function goToLevels() {
            console.log("📋 العودة لقائمة المستويات");
            if (window.Android && Android.goToLevels) {
                Android.goToLevels();
            } else {
                window.location.href = "levels.html";
            }
        }

        function goBack() {
            if (window.Android && Android.goBack) {
                Android.goBack();
            } else {
                window.location.href = "levels.html";
            }
        }

        // دوال مساعدة
        function shuffleLetters(text) {
            return text.split('').sort(() => Math.random() - 0.5).join('');
        }

        function generateExtraLetters() {
            const arabicLetters = 'ابتثجحخدذرزسشصضطظعغفقكلمنهوي';
            let extra = '';
            const extraCount = 12 - currentAnswer.length;
            
            for (let i = 0; i < extraCount; i++) {
                extra += arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
            }
            
            return extra;
        }

        function getUrlParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        document.addEventListener('DOMContentLoaded', loadGame);
    </script>
</body>
</html>